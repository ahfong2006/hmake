---
format: hypermake.v0

name: hmake
description: HyperMake builds your project without pre-requisites

targets:
    builder:
        description: build the docker image including toolchain
        build: builder/Dockerfile
        image: hmake-builder:latest
        watches:
            - builder

    hmake-linux-amd64:
        description: static linked hmake binary for Linux AMD64
        after:
            - vendor
        watches:
            - '**/**/*.go'
        envs:
            - GOOS=linux
            - GOARCH=amd64
        cmds:
            - env
            - >
                go build -o bin/hmake-$GOOS-$GOARCH
                -a -tags 'static_build netgo' -installsuffix netgo
                -ldflags '-extldflags -static'
                .

    hmake-darwin-amd64:
        description: static linked hmake binary for Mac OS
        after:
            - vendor
        watches:
            - '**/**/*.go'
        envs:
            - GOOS=darwin
            - GOARCH=amd64
        cmds:
            - env
            - >
                go build -o bin/hmake-$GOOS-$GOARCH
                -a -tags 'static_build netgo' -installsuffix netgo
                -ldflags '-extldflags -static'
                .

    vendor:
        description: pull all vendor packages
        after:
            - builder
        watches:
            - 'vendor/manifest'
        cmds:
            - 'gvt restore'
            - 'mkdir -p bin'

    test:
        description: run tests
        after:
            - vendor
        watches:
            - '**/**/*.go'
        cmds:
            - >
                go test -coverprofile cover.out
                -coverpkg ./project,./docker,./shell
                ./test

    all:
        after:
            - hmake-linux-amd64
            - hmake-darwin-amd64

settings:
    default-targets:
        - all
    docker:
        image: hmake-builder:latest
        src-volume: /go/src/github.com/evo-cloud/hmake
